# FWEA-I Cloudflare Worker Configuration
# This file configures the deployment settings for your audio cleaning service

name = "fwea-i-backend"
main = "worker.js"
compatibility_date = "2024-12-10"
compatibility_flags = ["nodejs_compat"]

# Worker settings
workers_dev = true
route = { pattern = "api.fwea-i.com/*", zone_name = "fwea-i.com" }

# Durable Objects
[durable_objects]
bindings = [
  { name = "PROCESSING_STATE", class_name = "ProcessingStateV2" }
]

[[migrations]]
tag = "v1"
new_classes = ["ProcessingStateV2"]

# R2 Storage for audio files
[[r2_buckets]]
binding = "AUDIO_STORAGE"
bucket_name = "fwea-i-audio-files"
preview_bucket_name = "fwea-i-audio-files-preview"

# D1 Database for user data and analytics
[[d1_databases]]
binding = "DB"
database_name = "fwea-i-production"
database_id = "your-database-id-here"
preview_database_id = "your-preview-database-id-here"

# KV Storage for profanity lists and caching
[[kv_namespaces]]
binding = "PROFANITY_LISTS"
id = "your-profanity-kv-id-here"
preview_id = "your-profanity-kv-preview-id-here"

# Workers AI binding
[ai]
binding = "AI"

# Queue for background processing
[[queues]]
binding = "PROCESSING_QUEUE"
queue_name = "audio-processing"

# Environment variables (secrets managed via dashboard/CLI)
[vars]
FRONTEND_URL = "https://fwea-i.com"
WORKER_BASE_URL = "https://api.fwea-i.com"

# Development environment
[env.development]
name = "fwea-i-backend-dev"
workers_dev = true

[env.development.vars]
FRONTEND_URL = "http://localhost:3000"
WORKER_BASE_URL = "http://localhost:8787"

# R2 buckets for development
[[env.development.r2_buckets]]
binding = "AUDIO_STORAGE"
bucket_name = "fwea-i-audio-files-dev"

# D1 database for development
[[env.development.d1_databases]]
binding = "DB"
database_name = "fwea-i-development"
database_id = "your-dev-database-id-here"

# KV namespace for development
[[env.development.kv_namespaces]]
binding = "PROFANITY_LISTS"
id = "your-dev-profanity-kv-id-here"

# Staging environment
[env.staging]
name = "fwea-i-backend-staging"
route = { pattern = "staging-api.fwea-i.com/*", zone_name = "fwea-i.com" }

[env.staging.vars]
FRONTEND_URL = "https://staging.fwea-i.com"
WORKER_BASE_URL = "https://staging-api.fwea-i.com"

# R2 buckets for staging
[[env.staging.r2_buckets]]
binding = "AUDIO_STORAGE"
bucket_name = "fwea-i-audio-files-staging"

# D1 database for staging
[[env.staging.d1_databases]]
binding = "DB"
database_name = "fwea-i-staging"
database_id = "your-staging-database-id-here"

# KV namespace for staging
[[env.staging.kv_namespaces]]
binding = "PROFANITY_LISTS"
id = "your-staging-profanity-kv-id-here"

# Production environment (inherits top-level settings)
[env.production]
name = "fwea-i-backend-prod"
route = { pattern = "api.fwea-i.com/*", zone_name = "fwea-i.com" }

# Build configuration
[build]
command = "npm run build"

# Upload rules
[upload]
rules = [
  { type = "ESModule", globs = ["**/*.js", "**/*.mjs"] },
  { type = "CompiledWasm", globs = ["**/*.wasm"] },
  { type = "Text", globs = ["**/*.txt", "**/*.json"] }
]

# Limits
[limits]
cpu_ms = 30000
memory_mb = 128

# Observability
[observability]
enabled = true
