name = "omnibackend2"
# change to "worker/worker.js" if the file is under /worker
main = "worker.js"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]
workers_dev = true

# ---------- Shared defaults ----------
[vars]
# Keep empty so env-specific values below take precedence.

# ---- KV (Cache) ----
[[kv_namespaces]]
binding = "CACHE"
id = "8a95ca1107eb4a8f95e23d6b47cfeab4"

# ---- D1 Database ----
[[d1_databases]]
binding = "DB"
database_name = "omnidb"
database_id = "014dc18a-e6cc-4efd-85d6-97434f1d994e"

# ---- R2 Bucket (audio) ----
[[r2_buckets]]
binding = "AUDIO_STORAGE"
bucket_name = "fwea-audio-files"

# ---- Workers AI ----
[ai]
binding = "AI"

# ---- Analytics Engine ----
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "omni_analytics"

# ---- Durable Objects ----
[[durable_objects.bindings]]
name = "PROCESSING_STATE_V2"
class_name = "ProcessingStateV2"

# ---- Durable Object migrations ----
[[migrations]]
tag = "v1"
new_classes = ["ProcessingStateV2"]

[build]
command = ""

[placement]
mode = "smart"

# ================== DEVELOPMENT ==================
[env.development]
[env.development.vars]
ENVIRONMENT       = "development"
FRONTEND_URL      = "http://localhost:3000"
WORKER_BASE_URL   = "https://omnibackend2.fweago-flavaz.workers.dev"

# --- TRANSCRIPTION VARS ---
# Your RunPod FastAPI endpoint + token used by the Worker
TRANSCRIBE_ENDPOINT = "https://rvxah7xwk0ql9p-8000.proxy.runpod.net"
TRANSCRIBE_TOKEN    = "omni3"

ADMIN_API_TOKEN   = "DEV_ONLY_CHANGE_ME"   # or set as a secret for dev

[[env.development.kv_namespaces]]
binding = "CACHE"
id = "8a95ca1107eb4a8f95e23d6b47cfeab4"

[[env.development.kv_namespaces]]
binding = "PROFANITY_LISTS"
id = "PROFANITY_LISTS_DEV_ID"

[[env.development.r2_buckets]]
binding = "AUDIO_STORAGE"
bucket_name = "fwea-audio-files"

[env.development.ai]
binding = "AI"

[[env.development.analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "omni_analytics"

[[env.development.durable_objects.bindings]]
name = "PROCESSING_STATE_V2"
class_name = "ProcessingStateV2"

# ================== PREVIEW ==================
[env.preview]
[env.preview.vars]
ENVIRONMENT       = "preview"
FRONTEND_URL      = "https://omni2-8d2.pages.dev"
WORKER_BASE_URL   = "https://omnibackend2.fweago-flavaz.workers.dev"

# --- TRANSCRIPTION VARS ---
TRANSCRIBE_ENDPOINT = "https://rvxah7xwk0ql9p-8000.proxy.runpod.net"
TRANSCRIBE_TOKEN    = "omni3"

[[env.preview.kv_namespaces]]
binding = "CACHE"
id = "8a95ca1107eb4a8f95e23d6b47cfeab4"

[[env.preview.kv_namespaces]]
binding = "PROFANITY_LISTS"
id = "PROFANITY_LISTS_DEV_ID"

[[env.preview.d1_databases]]
binding = "DB"
database_name = "omnidb"
database_id = "014dc18a-e6cc-4efd-85d6-97434f1d994e"

[[env.preview.r2_buckets]]
binding = "AUDIO_STORAGE"
bucket_name = "fwea-audio-files"

[env.preview.ai]
binding = "AI"

[[env.preview.analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "omni_analytics"

[[env.preview.durable_objects.bindings]]
name = "PROCESSING_STATE_V2"
class_name = "ProcessingStateV2"

# ================== PRODUCTION ==================
[env.production]
[env.production.vars]
ENVIRONMENT       = "production"
FRONTEND_URL      = "https://fwea-i.com"
WORKER_BASE_URL   = "https://omnibackend2.fweago-flavaz.workers.dev"

# --- TRANSCRIPTION VARS ---
# Swap to a stable domain when you have one; using RunPod for now:
TRANSCRIBE_ENDPOINT = "https://rvxah7xwk0ql9p-8000.proxy.runpod.net"
TRANSCRIBE_TOKEN    = "omni3"

# Required prod secrets (set via: wrangler secret put --env production <NAME>)
# STRIPE_SECRET_KEY, AUDIO_URL_SECRET, ADMIN_API_TOKEN, STRIPE_WEBHOOK_SECRET

[[env.production.kv_namespaces]]
binding = "CACHE"
id = "8a95ca1107eb4a8f95e23d6b47cfeab4"

[[env.production.kv_namespaces]]
binding = "PROFANITY_LISTS"
id = "PROFANITY_LISTS_PROD_ID"

[[env.production.d1_databases]]
binding = "DB"
database_name = "omnidb"
database_id = "014dc18a-e6cc-4efd-85d6-97434f1d994e"

[[env.production.r2_buckets]]
binding = "AUDIO_STORAGE"
bucket_name = "fwea-audio-files"

[env.production.ai]
binding = "AI"

[[env.production.analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "omni_analytics"

[[env.production.durable_objects.bindings]]
name = "PROCESSING_STATE_V2"
class_name = "ProcessingStateV2"

# Optional custom routing:
# [[env.production.routes]]
# pattern = "fwea-i.com/api/*"
# zone_name = "fwea-i.com"
