<script>
/* ===========================
   FWEA-I Frontend (Full Rewrite)
   =========================== */

///////////////////////
// Global Config
///////////////////////
const CONFIG = {
  STRIPE_PUBLISHABLE_KEY: 'pk_live_51RW06LJ2Iq1764pCr02p7yLia0VqBgUcRfG7Qm5OWFNAwFZcexIs9iBB3B9s22elcQzQjuAUMBxpeUhwcm8hsDf900NbCbF3Vw', // live key
  API_BASE_URL: 'https://omnibackend2.fweago-flavaz.workers.dev',                                           // worker url
  PREVIEW_DURATION: 30,
  STUDIO_PREVIEW_DURATION: 60,
  MAX_FILE_SIZE: 100 * 1024 * 1024,
  SUPPORTED_FORMATS: ['mp3', 'wav', 'flac', 'm4a', 'aac', 'ogg'],
  STRIPE_PRICES: {
    SINGLE_TRACK: 'price_1S4NnmJ2Iq1764pCjA9xMnrn',
    DJ_PRO: 'price_1S4NpzJ2Iq1764pCcZISuhug',
    STUDIO_ELITE: 'price_1S4Nr3J2Iq1764pCzHY4zIWr',
    DAY_PASS: 'price_1S4NsTJ2Iq1764pCCbru0Aao'
  },
  LANGUAGES: [
    'English','Haitian Creole','Spanish','French','German','Italian','Portuguese','Russian','Chinese','Japanese','Pidgin English','Korean',
    'Arabic','Hindi','Bengali','Turkish','Vietnamese','Thai','Yoruba','Igbo','Indonesian','Malay','Filipino','Hebrew',
    'Dutch','Swedish','Norwegian','Danish','Finnish','Polish','Czech','Hungarian','Romanian','Bulgarian',
    'Croatian','Serbian','Slovak','Slovenian','Estonian','Latvian','Lithuanian','Greek','Ukrainian','Belarusian',
    'Albanian','Macedonian','Bosnian','Montenegrin','Icelandic','Irish','Welsh','Scottish Gaelic','Breton','Basque',
    'Catalan','Galician','Luxembourgish','Maltese','Swahili','Hausa','Amharic','Somali',
    'Zulu','Xhosa','Afrikaans','Shona','Kikuyu','Luo','Kinyarwanda','Kirundi','Luganda','Wolof',
    'Bambara','Fula','Mandinka','Akan','Ewe','Ga','Twi','Fante','Dagbani','Kasem',
    'Urdu','Punjabi','Sindhi','Pashto','Dari','Farsi','Tajik','Uzbek','Kazakh','Kyrgyz',
    'Turkmen','Azerbaijani','Armenian','Georgian','Mongolian','Tibetan','Uyghur','Burmese','Khmer','Lao',
    'Telugu','Tamil','Malayalam','Kannada','Marathi','Gujarati','Odia','Assamese','Nepali','Sinhala','Tok Pisin'
  ]
};

///////////////////////
// Simple Analytics
///////////////////////
const ANALYTICS = {
  track(event, action, value = null) {
    const payload = {
      event, action, value,
      timestamp: Date.now(),
      userAgent: navigator.userAgent.substring(0, 80),
      url: location.href,
      referrer: document.referrer
    };
    try {
      const list = JSON.parse(localStorage.getItem('omni_analytics') || '[]');
      list.push(payload);
      localStorage.setItem('omni_analytics', JSON.stringify(list.slice(-50)));
      fetch(`${CONFIG.API_BASE_URL}/track-event`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).catch(()=>{});
    } catch {}
  },
  conversion(stage, plan, amount = null) {
    this.track('conversion', stage, amount);
    console.log(`ðŸŽ¯ conversion: ${stage} (${plan})`);
  }
};

///////////////////////
// Auth & Access
///////////////////////
const FWEA_AUTH = {
  generateFingerprint() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('FWEA Browser ID', 2, 2);
    return btoa(JSON.stringify({
      canvas: canvas.toDataURL().slice(-32),
      tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
      lang: navigator.language,
      plat: navigator.platform,
      res: `${screen.width}x${screen.height}`,
      cores: navigator.hardwareConcurrency || 4,
      mem: navigator.deviceMemory || 4
    }));
  },
  encrypt(obj) { return btoa(JSON.stringify(obj) + '_fwea_secure'); },
  decrypt(str) {
    try { return JSON.parse(atob(str).replace('_fwea_secure','')); } catch { return null; }
  },
  fingerprintMatch(a,b){
    try{
      const A=JSON.parse(atob(a)),B=JSON.parse(atob(b));
      const score = [
        A.tz===B.tz, A.lang===B.lang, A.plat===B.plat, A.res===B.res,
        Math.abs((A.cores||0)-(B.cores||0))<=1,
        Math.abs((A.mem||0)-(B.mem||0))<=2
      ].filter(Boolean).length;
      return score>=4;
    }catch{return false;}
  },
  getPlanFeatures(plan){
    const map={
      free:{preview:30, full:false, quality:'preview'},
      single_track:{preview:30, full:true, quality:'hd'},
      day_pass:{preview:30, full:true, quality:'hd'},
      dj_pro:{preview:30, full:true, quality:'professional', batch:true},
      studio_elite:{preview:60, full:true, quality:'studio', batch:true, api:true}
    }; return map[plan]||map.free;
  },
  async activateSubscription(plan, sessionId, email=null){
    const fp = this.generateFingerprint();
    const data = { plan, sessionId, email, activated: Date.now(), fingerprint: fp };
    localStorage.setItem('fwea_access', this.encrypt(data));
    try{
      await fetch(`${CONFIG.API_BASE_URL}/activate-access`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ fingerprint:fp, plan, sessionId, email })
      });
      showSuccess(`ðŸŽ‰ ${plan.replace('_',' ').toUpperCase()} activated`);
      this.updateUIForPlan(plan);
      return true;
    }catch(e){ console.error(e); return false; }
  },
  async validateAccess(){
    const raw = localStorage.getItem('fwea_access');
    if(!raw) return {valid:false, plan:'free', reason:'none'};
    const local = this.decrypt(raw); if(!local) return {valid:false, plan:'free', reason:'corrupt'};
    // day pass expiry
    if(local.plan==='day_pass' && Date.now()-local.activated>24*60*60*1000){
      localStorage.removeItem('fwea_access');
      return {valid:false, plan:'free', reason:'expired'};
    }
    // device match
    const current = this.generateFingerprint();
    if(!this.fingerprintMatch(local.fingerprint,current)){
      localStorage.removeItem('fwea_access');
      return {valid:false, plan:'free', reason:'device_mismatch'};
    }
    // server validation for subs (not needed for single_track)
    if(['dj_pro','studio_elite','day_pass'].includes(local.plan)){
      try{
        const r = await fetch(`${CONFIG.API_BASE_URL}/validate-subscription`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ fingerprint:current, sessionId:local.sessionId, plan:local.plan })
        });
        const v = await r.json();
        if(!v.valid){ localStorage.removeItem('fwea_access'); return {valid:false, plan:'free', reason:'invalid'}; }
      }catch(e){ console.warn('offline subscription validation',e); }
    }
    return {valid:true, plan:local.plan, features:this.getPlanFeatures(local.plan), fingerprint:current, sessionId:local.sessionId};
  },
  updateUIForPlan(plan){
    let badge = document.getElementById('plan-badge');
    if(!badge){
      badge=document.createElement('div'); badge.id='plan-badge';
      badge.style.cssText='position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#00d4ff,#00ff88);color:#0a0a0a;padding:8px 16px;border-radius:20px;font-weight:700;font-size:12px;z-index:1000';
      document.body.appendChild(badge);
    }
    const names={single_track:'ðŸŽµ Single Track',day_pass:'â° Day Pass',dj_pro:'ðŸŽ§ DJ Pro',studio_elite:'ðŸ† Studio Elite'};
    badge.textContent=names[plan]||'ðŸ†“ Free';
    if(plan!=='free'){
      const sub = document.querySelector('.upload-subtitle');
      if(sub) sub.textContent='Premium activated â€” drop a file for instant professional cleaning.';
    }
  }
};

///////////////////////
// Anti-piracy (light)
///////////////////////
const ANTI_PIRACY = {
  init(){
    // block right-click on player
    document.addEventListener('contextmenu', e=>{
      if(e.target.tagName==='AUDIO' || e.target.closest('.audio-player')){ e.preventDefault(); showNotification('ðŸ’¡ Upgrade for full downloads.'); }
    });
    // moving watermark while playing
    let timer=null;
    window.addEventListener('audio-play', ()=>{ timer=setInterval(()=>this.watermark(),3000); });
    window.addEventListener('audio-pause', ()=>{ if(timer) clearInterval(timer); });
  },
  watermark(){
    const w=document.createElement('div');
    w.textContent=`FWEA-I Preview â€¢ ${new Date().toISOString().slice(0,16)}`;
    w.style.cssText=`position:fixed;top:${10+Math.random()*70}%;left:${10+Math.random()*70}%;color:rgba(0,212,255,.45);font-weight:700;font-size:14px;pointer-events:none;z-index:9999;background:rgba(0,0,0,.3);padding:4px 12px;border-radius:12px;backdrop-filter:blur(5px);transform:rotate(${Math.random()*40-20}deg);animation:fadeInOut 4s ease-in-out`;
    document.body.appendChild(w); setTimeout(()=>w.remove(),4000);
  }
};

///////////////////////
// DOM References
///////////////////////
const el = {
  uploadArea: null,
  fileInput: null,
  processing: null,
  processingStatus: null,
  progressFill: null,
  progressLine: null,
  progressPct: null,
  timeRemaining: null,
  detectedLanguages: null,
  audioPlayer: null,
  player: null,
  playBtn: null,
  timeDisplay: null,
  wordsRemoved: null,
  languagesDetected: null,
  pricing: null,
};

///////////////////////
// State
///////////////////////
let currentFile = null;
let isProcessing = false;
let stripe = null;
let accessState = { valid:false, plan:'free' };

///////////////////////
// Init
///////////////////////
document.addEventListener('DOMContentLoaded', async () => {
  stripe = Stripe(CONFIG.STRIPE_PUBLISHABLE_KEY);

  // bind DOM
  el.uploadArea = document.getElementById('uploadArea');
  el.fileInput = document.getElementById('fileInput');
  el.processing = document.getElementById('processingSection');
  el.processingStatus = document.getElementById('processingStatus');
  el.progressFill = document.getElementById('progressFill');
  el.progressLine = document.getElementById('progressLine');
  el.progressPct = document.getElementById('progressPercentage');
  el.timeRemaining = document.getElementById('timeRemaining');
  el.detectedLanguages = document.getElementById('detectedLanguages');
  el.audioPlayer = document.getElementById('audioPlayer');
  el.player = document.getElementById('player');
  el.playBtn = document.getElementById('playBtn');
  el.timeDisplay = document.getElementById('timeDisplay');
  el.wordsRemoved = document.getElementById('wordsRemoved');
  el.languagesDetected = document.getElementById('languagesDetected');
  el.pricing = document.getElementById('pricing');

  // listeners
  el.fileInput.addEventListener('change', onFileSelect);
  el.uploadArea.addEventListener('dragover', e=>{e.preventDefault(); el.uploadArea.classList.add('drag-over');});
  el.uploadArea.addEventListener('dragleave', e=>{e.preventDefault(); el.uploadArea.classList.remove('drag-over');});
  el.uploadArea.addEventListener('drop', onDrop);
  el.playBtn.addEventListener('click', togglePlayback);
  el.player.addEventListener('timeupdate', syncPlayerTime);
  el.player.addEventListener('ended', ()=>{ el.playBtn.textContent='â–¶ï¸'; window.dispatchEvent(new Event('audio-pause')); });

  // language banner
  const lane = document.getElementById('languageScroll');
  if(lane){ lane.innerHTML = [...CONFIG.LANGUAGES, ...CONFIG.LANGUAGES].map(l=>`<span class="language-item">${l}</span>`).join(''); }

  // anti-piracy
  ANTI_PIRACY.init();

  // access
  accessState = await FWEA_AUTH.validateAccess();
  if(accessState.valid && accessState.plan!=='free'){ FWEA_AUTH.updateUIForPlan(accessState.plan); showSuccess(`Welcome back â€” ${accessState.plan.toUpperCase()} active.`); }

  ANALYTICS.track('page_view','loaded');
});

///////////////////////
// Upload + Process
///////////////////////
function onDrop(e){
  e.preventDefault(); el.uploadArea.classList.remove('drag-over');
  const f = [...e.dataTransfer.files].find(f=>f.type.startsWith('audio/'));
  if(!f) return showError('Please drop a valid audio file.');
  processFile(f);
}
function onFileSelect(e){
  const f = e.target.files[0];
  if(f) processFile(f);
}

function validateFile(file){
  if(file.size>CONFIG.MAX_FILE_SIZE){ showError(`File too large. Max ${(CONFIG.MAX_FILE_SIZE/(1024*1024)).toFixed(0)}MB`); return false; }
  const ext = (file.name.split('.').pop()||'').toLowerCase();
  if(!CONFIG.SUPPORTED_FORMATS.includes(ext)){ showError(`Unsupported format. Use: ${CONFIG.SUPPORTED_FORMATS.join(', ')}`); return false; }
  return true;
}

async function processFile(file){
  if(isProcessing) return showError('Please wait for current processing to finish.');
  if(!validateFile(file)) return;

  currentFile = file;
  ANALYTICS.track('user_action','file_uploaded', file.size);

  // UI: show processing pane
  isProcessing = true;
  el.processing.style.display='block';
  document.querySelector('.upload-section').style.display='none';
  resetProgress();
  progressiveStages();

  // figure plan + fingerprint
  const fp = FWEA_AUTH.generateFingerprint();
  const plan = accessState?.plan || 'free';

  try{
    const fd = new FormData();
    fd.append('audio', file);        // MUST match Worker
    fd.append('fingerprint', fp);
    fd.append('planType', plan);

    const res = await fetch(`${CONFIG.API_BASE_URL}/process-audio`, { method:'POST', body: fd });
    const json = await res.json();
    if(!res.ok || !json.success) throw new Error(json?.error || 'Processing failed');

    // fill UI from backend response
    // expects: previewUrl, fullAudioUrl, detectedLanguages, wordsRemoved, previewDuration
    if(Array.isArray(json.detectedLanguages)){
      el.detectedLanguages.innerHTML = '';
      json.detectedLanguages.forEach((lang,i)=>{
        const tag = document.createElement('span');
        tag.className='language-tag'; tag.textContent=lang;
        setTimeout(()=>el.detectedLanguages.appendChild(tag), i*150);
      });
    }
    el.wordsRemoved.textContent = json.wordsRemoved ?? 0;
    el.languagesDetected.textContent = Array.isArray(json.detectedLanguages) ? json.detectedLanguages.length : 1;

    // ready player
    el.player.src = json.previewUrl;
    el.player.style.display = 'block';

    // finish progress & reveal player
    finishProgress().then(()=>completeProcessing());

    // store full url in memory (not exposed in DOM)
    window.__fweaPreviewUrl = json.previewUrl;
    window.__fweaFullUrl = json.fullAudioUrl || null;

    ANALYTICS.conversion('preview_completed', plan);
  }catch(err){
    console.error(err);
    showError('âš ï¸ Audio processing failed. Please try again.');
    isProcessing=false;
    el.processing.style.display='none';
    document.querySelector('.upload-section').style.display='block';
  }
}

function resetProgress(){
  setProgress(0);
  el.processingStatus.textContent = 'Initializing AI engine...';
  el.detectedLanguages.innerHTML='';
  ['stage1','stage2','stage3','stage4','stage5'].forEach(id=>{
    const s = document.getElementById(id);
    s?.classList.remove('active'); s?.classList.remove('completed');
  });
}

function setProgress(p){
  const val = Math.max(0, Math.min(100, p));
  el.progressFill.style.width = val+'%';
  el.progressLine.style.width = val+'%';
  el.progressPct.textContent = `${Math.round(val)}%`;
  const eta = Math.max(1, Math.ceil((100-val)*0.02));
  el.timeRemaining.textContent = `Estimated time: ${eta} seconds`;
}

async function progressiveStages(){
  const stages = [
    { id:'stage1', text:'Analyzing audio waveform and structure...', dur: 1200 },
    { id:'stage2', text:'Detecting languages using AI models...', dur: 900 },
    { id:'stage3', text:'Identifying and mapping inappropriate content...', dur: 1500 },
    { id:'stage4', text:'Reconstructing clean audio segments...', dur: 1300 },
    { id:'stage5', text:'Enhancing quality and finalizing output...', dur: 800 }
  ];
  let acc=0;
  for(const s of stages){
    el.processingStatus.textContent = s.text;
    document.getElementById(s.id)?.classList.add('active');
    await animate(acc, acc+20, s.dur);
    document.getElementById(s.id)?.classList.remove('active');
    document.getElementById(s.id)?.classList.add('completed');
    acc += 20;
  }
}
function animate(from,to,dur){
  return new Promise(res=>{
    const start=Date.now();
    const tick=()=>{
      const t=(Date.now()-start)/dur;
      const p = from + (to-from)*Math.min(1,t);
      setProgress(p);
      if(t<1) requestAnimationFrame(tick); else res();
    };
    tick();
  });
}
function finishProgress(){ return animate(parseFloat(el.progressPct.textContent)||80, 100, 600); }

function completeProcessing(){
  isProcessing=false;
  el.processing.style.display='none';
  el.audioPlayer.style.display='block';
  el.audioPlayer.classList.add('fade-in');
}

///////////////////////
// Player
///////////////////////
function togglePlayback(){
  if(!el.player.src) return;
  if(el.player.paused){
    el.player.play(); el.playBtn.textContent='â¸ï¸'; window.dispatchEvent(new Event('audio-play'));
  }else{
    el.player.pause(); el.playBtn.textContent='â–¶ï¸'; window.dispatchEvent(new Event('audio-pause'));
  }
}
function syncPlayerTime(){
  const cur = Math.floor(el.player.currentTime||0);
  const dur = Math.floor(el.player.duration|| (accessState.plan==='studio_elite'?CONFIG.STUDIO_PREVIEW_DURATION:CONFIG.PREVIEW_DURATION));
  el.timeDisplay.textContent = `${formatTime(cur)} / ${formatTime(dur)}`;
}
function formatTime(s){ const m=Math.floor(s/60), ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }

///////////////////////
// Pricing / Stripe
///////////////////////
async function startCheckout(type, priceId, amount){
  if(document.body.classList.contains('admin-mode')){ showSuccess('Admin: full access granted.'); return; }
  ANALYTICS.conversion('checkout_started', type, amount);
  try{
    const fp = FWEA_AUTH.generateFingerprint();
    const email = null; // optional: collect via modal if you want prefill
    const r = await fetch(`${CONFIG.API_BASE_URL}/create-payment`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ priceId, type, fileName: currentFile?.name || 'audio_track', email, fingerprint: fp })
    });
    const j = await r.json();
    if(!r.ok) throw new Error(j?.error || 'Payment error');
    await stripe.redirectToCheckout({ sessionId: j.sessionId });
  }catch(e){
    console.error(e);
    showError('Payment processing failed. Please try again.');
  }
}

async function purchaseTrack(){ startCheckout('single_track', CONFIG.STRIPE_PRICES.SINGLE_TRACK, 4.99); }
async function purchaseDayPass(){ startCheckout('day_pass', CONFIG.STRIPE_PRICES.DAY_PASS, 9.99); }
async function purchaseDJPro(){ startCheckout('dj_pro', CONFIG.STRIPE_PRICES.DJ_PRO, 29.99); }
async function purchaseStudioElite(){ startCheckout('studio_elite', CONFIG.STRIPE_PRICES.STUDIO_ELITE, 99.99); }

// expose for buttons
window.purchaseTrack = purchaseTrack;
window.purchaseDayPass = purchaseDayPass;
window.purchaseDJPro = purchaseDJPro;
window.purchaseStudioElite = purchaseStudioElite;

///////////////////////
// UI helpers
///////////////////////
function showPricingModal(){ document.getElementById('pricing').scrollIntoView({behavior:'smooth'}); ANALYTICS.conversion('pricing_viewed','free'); }
function downloadPreview(){
  if(!window.__fweaPreviewUrl){ return showError('No preview available yet.'); }
  const a = document.createElement('a'); a.href = window.__fweaPreviewUrl; a.download = (currentFile?.name || 'preview') + '.mp3'; document.body.appendChild(a); a.click(); a.remove();
  showSuccess('Preview download started.'); ANALYTICS.conversion('preview_download','free');
}
window.showPricingModal = showPricingModal;
window.downloadPreview = downloadPreview;

function showError(msg){ notify(msg,'error'); }
function showSuccess(msg){ notify(msg,'success'); }
function showWarning(msg){ notify(msg,'warning'); }
function showNotification(msg){ notify(msg,'info'); }
function notify(message, type){
  const colors={ error:'rgba(255,68,68,.95)', success:'rgba(0,255,136,.95)', warning:'rgba(255,165,0,.95)', info:'rgba(0,212,255,.95)' };
  const n=document.createElement('div');
  n.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:${colors[type]};color:#fff;border-radius:12px;font-weight:700;z-index:1000;backdrop-filter:blur(10px);animation:slideInRight .3s ease;max-width:420px;`;
  n.textContent=message; document.body.appendChild(n); setTimeout(()=>n.remove(), 5000);
}

///////////////////////
// Admin mode flag
///////////////////////
(function checkAdmin(){
  const isAdmin = location.search.includes('admin=true') || localStorage.getItem('fwea_admin')==='true';
  if(isAdmin){ document.body.classList.add('admin-mode'); console.log('Admin mode active'); }
})();

// minimal global to satisfy any external callbacks
window.FWEA_AUTH = FWEA_AUTH;
</script>
